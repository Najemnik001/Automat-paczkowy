<!DOCTYPE html>
{% load webpush_notifications %}
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Strona Główna</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    {% webpush_header %}
    <style>
        body{
            min-height:100vh;
            background: linear-gradient(to right, #ff4d4f, #1890ff);
            display:flex;align-items:flex-start;justify-content:center;
            padding:40px 16px;
        }
        .page-card{
            background:#fff;color:#000; width:100%; max-width:1000px;
            border-radius:0; box-shadow:0 6px 14px rgba(0,0,0,.15);
            padding:28px;
        }
        .btn, .list-group-item{
            border-radius:0 !important;
        }
        .section-title{
            border-left:6px solid #1565c0;
            padding-left:12px; margin-top:24px; margin-bottom:12px;
        }
        .badge-status{ font-weight:600; }
        .parcel-actions .btn{ margin-left:8px; }
        .logout-wrap{ gap:8px; }
    </style>
</head>
<body>
<div class="page-card">

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <h1 class="m-0">Witaj, {{ user.username }}!</h1>
        <div class="d-flex logout-wrap">
                <div class="d-flex logout-wrap align-items-center gap-2">
                    <form action="{% url 'logout' %}" method="post" class="m-0">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger">Wyloguj się</button>
                    </form>

                    <span id="webpush-hidden" style="position:absolute; left:-9999px; top:auto;">
                      {% webpush_button %}
                    </span>

                    <button id="webpush-toggle" type="button" class="btn btn-outline-primary">
                      Włącz powiadomienia push
                    </button>
                </div>
        </div>
    </div>

    <h4 class="section-title">Paczki nadane do Ciebie</h4>
    {% if received_parcels %}
        <ul class="list-group mb-3">
            {% for parcel in received_parcels %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-3">
                        <div class="fw-semibold">{{ parcel.name }}</div>
                        <small>
                            {% if parcel.status == 'shipment_ordered' %}
                                <span class="badge bg-secondary badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'stored_in_machine' %}
                                <span class="badge bg-primary badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'picked_up_by_courier' %}
                                <span class="badge bg-warning text-dark badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'delivered_to_machine' %}
                                <span class="badge bg-info text-dark badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'received_by_recipient' %}
                                <span class="badge bg-success badge-status">{{ parcel.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-dark">unknown</span>
                            {% endif %}
                            {% if parcel.delivered_at %} • Dostarczona: {{ parcel.delivered_at|date:"Y-m-d H:i"|default:"Brak" }}{% endif %}
                            {% if parcel.sent_to_machine %}
                                Automat odbiorczy: {{ parcel.sent_to_machine.name }} ({{ parcel.sent_to_machine.location }})
                            {% endif %}
                        </small>
                    </div>

                    {% if parcel.status == 'delivered_to_machine' %}
                        <div class="parcel-actions">
                            <button class="btn btn-success receive_parcel"
                                    data-parcel-id="{{ parcel.id }}">
                                Odbierz paczkę
                            </button>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="alert alert-info">Nie masz paczek jadących do Ciebie.</div>
    {% endif %}

    <h4 class="section-title">Twoje wysłane paczki</h4>
    {% if sent_parcels %}
        <ul class="list-group mb-3">
            {% for parcel in sent_parcels %}
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-3">
                        <div class="fw-semibold">{{ parcel.name }}</div>
                        <small>
                            {% if parcel.status == 'shipment_ordered' %}
                                <span class="badge bg-secondary badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'stored_in_machine' %}
                                <span class="badge bg-primary badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'picked_up_by_courier' %}
                                <span class="badge bg-warning text-dark badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'delivered_to_machine' %}
                                <span class="badge bg-info text-dark badge-status">{{ parcel.get_status_display }}</span>
                            {% elif parcel.status == 'received_by_recipient' %}
                                <span class="badge bg-success badge-status">{{ parcel.get_status_display }}</span>
                            {% else %}
                                <span class="badge bg-dark">unknown</span>
                            {% endif %}
                            {% if parcel.delivered_at %} • Dostarczona: {{ parcel.delivered_at|date:"Y-m-d H:i"|default:"Brak" }}{% endif %}
                            {% if parcel.sent_from_machine %}
                                Automat nadawczy: {{ parcel.sent_from_machine.name }} ({{ parcel.sent_from_machine.location }})
                            {% endif %}
                        </small>
                    </div>

                    {% if parcel.status == 'shipment_ordered' %}
                        <div class="parcel-actions">
                            <button class="btn btn-primary store_in_machine"
                                    data-parcel-id="{{ parcel.id }}">
                                Przekaż paczkę do paczkomatu
                            </button>
                        </div>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="alert alert-info">Nie masz wysłanych paczek.</div>
    {% endif %}


    <a href="{% url 'create_parcel' %}" class="btn btn-outline-primary">Przejdź do nadawania paczki</a>
</div>

<script>
  // --- akcje paczkowe (bez zmian) ---
  $(function(){
    $(".store_in_machine").click(function(){
      var parcelId = $(this).data('parcel-id');
      alert("Umieść paczkę w automacie");
      $.ajax({
        url: "{% url 'mock_store_parcel' %}",
        type: "POST",
        data: {'parcel_id': parcelId, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success: function(){ alert("Paczka została umieszczona w skrytce!"); location.reload(); },
        error: function(){ alert("Wystąpił problem podczas procesu."); }
      });
    });

    $(".receive_parcel").click(function(){
      var parcelId = $(this).data('parcel-id');
      alert("Otwórz skrytkę i odbierz paczkę");
      $.ajax({
        url: "{% url 'mock_receive_parcel' %}",
        type: "POST",
        data: {'parcel_id': parcelId, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        success: function(){ alert("Przesyłka odebrana. Dziękujemy za skorzystanie z naszych usług!"); location.reload(); },
        error: function(){ alert("Wystąpił problem podczas odbioru paczki."); }
      });
    });
  });

  // --- synchronizacja napisu przycisku webpush ---
  (function(){
    function findHiddenBtn(){
      return document.querySelector('#webpush-hidden button, #webpush-hidden a, #webpush-hidden [data-webpush]');
    }
    function isSubscribed(hiddenBtn){
      var txt = (hiddenBtn.textContent || '').toLowerCase();
      return hiddenBtn.classList.contains('subscribed') ||
             txt.includes('disable') || txt.includes('unsubscribe') ||
             txt.includes('wyłącz') || txt.includes('subskrybowane');
    }
    function syncLabel(){
      if (!hiddenBtn || !visibleBtn) return;
      visibleBtn.textContent = isSubscribed(hiddenBtn)
        ? 'Wyłącz powiadomienia push'
        : 'Włącz powiadomienia push';
    }

    var visibleBtn = document.getElementById('webpush-toggle');
    var hiddenBtn  = null;

    // Poczekaj aż wszystko (w tym skrypty webpush) się załadują
    window.addEventListener('load', function(){
      hiddenBtn = findHiddenBtn();
      if (!visibleBtn || !hiddenBtn) return;

      // Ustaw label na start
      syncLabel();

      // Obserwuj zmiany tekstu/klas ukrytego przycisku (lib zmienia to po subskrypcji)
      var mo = new MutationObserver(syncLabel);
      mo.observe(hiddenBtn, {attributes:true, childList:true, subtree:true, attributeFilter:['class']});

      // Klik w widoczny -> przekaż do ukrytego i po chwili zsynchronizuj napis
      visibleBtn.addEventListener('click', function(){
        visibleBtn.disabled = true;
        try { hiddenBtn.click(); } catch(e){}
        // krótkie opóźnienie na aktualizację stanu w lib
        setTimeout(function(){
          syncLabel();
          visibleBtn.disabled = false;
        }, 800);
      });
    });

    // Awaryjny polling przez kilka sekund (gdyby MutationObserver nie „złapał” pierwszych zmian)
    var tries = 0;
    var poll = setInterval(function(){
      if (!hiddenBtn) hiddenBtn = findHiddenBtn();
      if (hiddenBtn && visibleBtn){
        syncLabel();
        tries++;
        if (tries > 10) clearInterval(poll);
      } else {
        tries++;
        if (tries > 20) clearInterval(poll);
      }
    }, 500);
  })();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel administratora</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body{
            min-height:100vh;
            background: linear-gradient(to right, #ff4d4f, #1890ff);
            display:flex;align-items:flex-start;justify-content:center;
            padding:40px 16px;
        }
        .page-card{
            background:#fff;color:#000; width:100%; max-width:1100px;
            border-radius:0; box-shadow:0 6px 14px rgba(0,0,0,.15);
            padding:28px;
        }
        .btn, .form-control, .list-group-item, .modal-content { border-radius:0 !important; }
        .section-title{
            border-left:6px solid #1565c0;
            padding-left:12px; margin-top:24px; margin-bottom:12px;
        }
        .gap-8{ gap:8px; }
        .toolbar .btn{ min-width: 190px; }
        .list-actions .btn{ margin-left:8px; }
    </style>
</head>
<body>
<div class="page-card">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
        <h1 class="m-0">Panel administratora</h1>
        <form method="post" action="{% url 'logout' %}" class="m-0">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">Wyloguj</button>
        </form>
    </div>

    <div class="toolbar d-flex flex-wrap gap-8 mb-3">
        <a href="{% url 'parcel_report' %}" class="btn btn-primary">Raport przesyłek</a>
        <a href="{% url 'user_report' %}" class="btn btn-primary">Raport użytkowników</a>
        <a href="{% url 'add_locker' %}" class="btn btn-outline-primary">Dodaj skrytkę</a>
    </div>

    <div class="row g-3">
        <div class="col-12 col-lg-6">
            <h4 class="section-title">Szukaj skrytki</h4>
            <form method="get" class="mb-3">
                <div class="input-group">
                    <input type="text" name="search_lockers" placeholder="Nazwa lub lokalizacja" class="form-control">
                    <button type="submit" class="btn btn-primary">Szukaj</button>
                </div>
            </form>

            {% if lockers %}
                <ul class="list-group">
                    {% for locker in lockers %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">{{ locker.name }}</div>
                                <small class="text-muted">{{ locker.location }}</small>
                            </div>
                            <div class="list-actions">
                                <a href="{% url 'edit_locker' locker.id %}" class="btn btn-outline-secondary btn-sm">Edytuj</a>
                                <a href="{% url 'delete_locker' locker.id %}" class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('Na pewno usunąć tę skrytkę?');">Usuń</a>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="alert alert-info">Brak wyników. Wpisz nazwę lub lokalizację i wyszukaj.</div>
            {% endif %}
        </div>


        <div class="col-12 col-lg-6">
            <h4 class="section-title">Szukaj użytkownika</h4>
            <form method="get" class="mb-3">
                <div class="input-group">
                    <input type="text" name="search_users" placeholder="Email, imię lub nazwisko" class="form-control">
                    <button type="submit" class="btn btn-primary">Szukaj</button>
                </div>
            </form>

            {% if users %}
                <ul class="list-group">
                    {% for user in users %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">{{ user.username }} {{ user.usersurname }}</div>
                                <small class="text-muted">Rola: {{ user.get_role_display }} • Email: {{ user.email }}</small>
                            </div>
                            <div class="list-actions">
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm open-edit-modal"
                                        data-user-id="{{ user.id }}"
                                        data-user-name="{{ user.username }} {{ user.usersurname }}"
                                        data-user-role="{{ user.get_role_display }}">
                                    Edytuj rolę
                                </button>
                                <a href="{% url 'delete_user' user.id %}" class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('Na pewno usunąć użytkownika?');">Usuń</a>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="alert alert-info">Brak wyników. Wpisz email, imię lub nazwisko i wyszukaj.</div>
            {% endif %}
        </div>
    </div>
</div>


<div class="modal fade" id="editRoleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Zmień rolę użytkownika</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zamknij"></button>
      </div>
      <div class="modal-body">
        <form id="editRoleForm">
          {% csrf_token %}
          <input type="hidden" id="modalUserId" name="user_id">
          <div class="mb-3">
            <label class="form-label">Użytkownik</label>
            <input type="text" id="modalUserName" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Rola</label>
            <select id="modalUserRole" name="role" class="form-control">
              <option value="client">Client</option>
              <option value="courier">Courier</option>
              <option value="admin">Administrator</option>
            </select>
          </div>
        </form>
        <div id="editRoleError" class="text-danger" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="saveRoleBtn" class="btn btn-primary">Zapisz</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  const modalEl = document.getElementById('editRoleModal');
  let bsModal;

  document.addEventListener('DOMContentLoaded', function(){
    bsModal = new bootstrap.Modal(modalEl);
    document.querySelectorAll('.open-edit-modal').forEach(btn => {
      btn.addEventListener('click', function(){
        const userId = this.dataset.userId;
        const userName = this.dataset.userName;
        const userRole = this.dataset.userRole;

        document.getElementById('modalUserId').value = userId;
        document.getElementById('modalUserName').value = userName;
        document.getElementById('modalUserRole').value = userRole;

        document.getElementById('editRoleError').style.display = 'none';
        bsModal.show();
      });
    });
      
    document.getElementById('saveRoleBtn').addEventListener('click', function(){
      const userId = document.getElementById('modalUserId').value;
      const role = document.getElementById('modalUserRole').value;

      fetch(`/users/${userId}/role/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ role })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          const box = document.getElementById('editRoleError');
          box.textContent = data.message || 'Nie udało się zaktualizować roli.';
          box.style.display = 'block';
        }
      })
      .catch(() => {
        const box = document.getElementById('editRoleError');
        box.textContent = 'Błąd sieci.';
        box.style.display = 'block';
      });
    });
  });
})();
</script>
</body>
</html>
